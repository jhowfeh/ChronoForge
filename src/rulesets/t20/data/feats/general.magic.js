// src/modules/CharSheetT20/services/features/general.magic.js
import { makeFeature, FeatureKind } from './_schema';
import { all, any, attrMin, levelMin, trained, prof, has, castsSpells } from './_prereq';

export const generalMagicFeatures = [
  makeFeature({
    id: 'general.magic.celebrar_ritual',
    name: "Celebrar Ritual",
    kind: FeatureKind.GENERAL_MAGIC,
    group: 'magic',
    source: {"type": "general"},
    text: "Você pode lançar magias como rituais... (execução 1 hora/dobro, custo T$10 por PM, dobra limite de PM). Pré-requisitos: treinado em Misticismo ou Religião, 8º nível de personagem. (Requer lançar magias).",
    prerequisites: [castsSpells(), levelMin(8), any(trained('misticismo'), trained('religiao'))],
  }),
  makeFeature({
    id: 'general.magic.escrever_pergaminho',
    name: "Escrever Pergaminho",
    kind: FeatureKind.GENERAL_MAGIC,
    group: 'magic',
    source: {"type": "general"},
    text: "Você pode usar Ofício (escriba) para fabricar pergaminhos com magias que conheça. Pré-requisitos: lançar magias (habilidade Magias), treinado em Ofício (escriba).",
    prerequisites: [castsSpells(), trained('oficio_escriba')],
  }),
  makeFeature({
    id: 'general.magic.foco_em_magia',
    name: "Foco em Magia",
    kind: FeatureKind.GENERAL_MAGIC,
    group: 'magic',
    source: {"type": "general"},
    text: "Escolha uma magia que possa lançar. Seu custo diminui em –1 PM (cumulativo). Você pode escolher este poder outras vezes para magias diferentes.",
    prerequisites: [castsSpells()],
    choiceRules: [{"key": "chosenSpell", "type": "PICK_SPELL", "count": 1, "filters": {"castableOnly": true}}],
  }),
  makeFeature({
    id: 'general.magic.magia_acelerada',
    name: "Magia Acelerada",
    kind: FeatureKind.GENERAL_MAGIC,
    group: 'magic',
    source: {"type": "general"},
    text: "Aprimoramento: execução vira ação livre; apenas em magias de movimento/padrão/completa; só 1 magia como ação livre por rodada. Custo: +4 PM. Pré-requisito: lançar magias de 2º círculo.",
    prerequisites: [castsSpells(), { op: 'NOTE', text: 'circle>=2' }],
  }),
  makeFeature({
    id: 'general.magic.magia_ampliada',
    name: "Magia Ampliada",
    kind: FeatureKind.GENERAL_MAGIC,
    group: 'magic',
    source: {"type": "general"},
    text: "Aprimoramento: aumenta alcance em um passo (curto→médio→longo) ou dobra a área. Custo: +2 PM.",
    prerequisites: [castsSpells()],
  }),
  makeFeature({
    id: 'general.magic.magia_discreta',
    name: "Magia Discreta",
    kind: FeatureKind.GENERAL_MAGIC,
    group: 'magic',
    source: {"type": "general"},
    text: "Aprimoramento: lança sem gestos/fala; permite mãos presas/amordaçado; permite magia arcana com armadura sem teste; percepção por Misticismo CD 20. Custo: +2 PM.",
    prerequisites: [castsSpells()],
  }),
  makeFeature({
    id: 'general.magic.magia_ilimitada',
    name: "Magia Ilimitada",
    kind: FeatureKind.GENERAL_MAGIC,
    group: 'magic',
    source: {"type": "general"},
    text: "Você soma seu atributo-chave no limite de PM que pode gastar numa magia.",
    prerequisites: [castsSpells()],
  }),
  makeFeature({
    id: 'general.magic.preparar_pocao',
    name: "Preparar Poção",
    kind: FeatureKind.GENERAL_MAGIC,
    group: 'magic',
    source: {"type": "general"},
    text: "Você pode usar Ofício (alquimista) para fabricar poções com magias conhecidas de 1º e 2º círculos. Pré-requisitos: lançar magias (habilidade Magias), treinado em Ofício (alquimista).",
    prerequisites: [castsSpells(), trained('oficio_alquimista')],
  }),
];